<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Girls and Getaways</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        :root {
            --tiffany-blue: #81D8D0;
            --header-bg: #000000;     /* Dark blue header */
            --green: #6CE6CB;         /* Deeper green */
            --red: #CB6ce6;          /* Deeper red */
            --yellow: #FFC87E;       /* Golden yellow */
            --primary: var(--header-bg);
            --border-color: #E5E5E5;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            color: #2C3E50;
            line-height: 1.6;
        }

        h1, h2, h3 {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
            font-weight: 600;
            color: #2C3E50;
        }

        .header-container {
            display: flex;
            align-items: center;
            gap: 30px;
            padding: 20px 0;
        }

        .logo-container {
            text-align: left;
            flex-shrink: 0;
        }

        .logo-container img {
            max-width: 150px;
            height: auto;
        }

        .header-text {
            flex-grow: 1;
        }

        .header-text h1 {
            margin: 0 0 10px 0;
        }

        .header-text p {
            margin: 0;
            color: #666;
        }

        .event-details {
            margin: 30px 0;
            padding: 30px;
            background: #FFFFFF;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .voting-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 20px 0;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }

        .voting-table th {
            background: var(--header-bg);
            color: white;             /* White text for better contrast */
            padding: 20px 15px;
            text-align: center;
            font-weight: 500;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }

        .voting-table td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .voting-table td:first-child {
            font-size: 18px;
            font-weight: 500;
        }

        .voting-table td:first-child strong {
            font-size: 18px;
            font-weight: 600;
        }

        .date-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            text-align: center;
            font-size: 14px;
            line-height: 1.3;
            white-space: normal;  /* Changed from nowrap */
            max-width: 100px;    /* Added max-width */
        }

        .date-number {
            font-size: 24px;
            font-weight: bold;
        }

        .date-month {
            font-size: 14px;
        }

        .date-time {
            font-size: 12px;
            margin-top: 5px;
            padding: 4px 8px;
            background: var(--primary);
            color: white;
            border-radius: 4px;
        }

        .vote-yes, .vote-no, .vote-pending {
            font-size: 24px;
            font-weight: 700;
            color: #000000;
        }

        .vote-yes {
            background-color: var(--green);
        }

        .vote-no {
            background-color: var(--red);
        }

        .vote-pending {
            background-color: var(--yellow);
        }

        .submit-btn {
            background: var(--tiffany-blue);
            color: #2C3E50; /* Dark font color */
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;  /* Inherit from body */
        }

        .submit-btn:hover {
            background: var(--tiffany-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(129, 216, 208, 0.2);
        }

        .name-capture {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .name-capture-content {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            width: 90%;
            max-width: 400px;
        }

        .name-capture input {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Montserrat', sans-serif;
            transition: border-color 0.2s ease;
        }

        .name-capture input:focus {
            outline: none;
            border-color: var(--tiffany-blue);
        }

        .voting-table td:hover:not([class]) {
            background-color: rgba(129, 216, 208, 0.1);
            cursor: pointer;
        }

        .instructions {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid var(--border-color);
        }

        .instructions h3 {
            color: var(--tiffany-blue);
            margin-top: 0;
        }

        .instructions ol {
            margin: 0;
            padding-left: 20px;
        }

        .name-select {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;  /* Inherit from body */
            transition: border-color 0.2s ease;
            background: white;
        }

        .name-select:focus {
            outline: none;
            border-color: var(--tiffany-blue);
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header-container {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .logo-container {
                margin: 0 auto;
            }

            .voting-table {
                font-size: 14px;
                margin: 10px -10px;
                width: calc(100% + 20px);
                overflow-x: auto;
                display: block;
            }

            .voting-table td, .voting-table th {
                padding: 8px 4px;
                min-width: 80px;
            }

            .name-capture-content {
                padding: 20px;
                width: 95%;
                margin: 10px;
            }

            .submit-btn {
                width: 100%;
                margin: 10px 0;
            }

            .instructions {
                margin: 10px -10px;
                border-radius: 0;
            }

            .date-header {
                font-size: 12px;
                padding: 4px;
            }

            .date-header {
                font-size: 12px;
            }
        }

        /* Small phone adjustments */
        @media (max-width: 480px) {
            .voting-table td:first-child {
                position: sticky;
                left: 0;
                background: white;
                z-index: 1;
                box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            }

            .voting-table td, .voting-table th {
                min-width: 60px;
            }

            .vote-yes, .vote-no, .vote-pending {
                font-size: 20px;
            }
        }

        /* Add touch-friendly tap targets */
        @media (hover: none) {
            .voting-table td {
                padding: 15px 8px;
            }

            button {
                min-height: 44px;
            }

            select, input {
                min-height: 44px;
                font-size: 16px; /* Prevents iOS zoom on focus */
            }
        }
    </style>
</head>
<body>
    <div class="header-container">
        <div class="logo-container">
            <img src="gng.png" alt="Girls and Getaways Logo">
        </div>
        <div class="header-text">
            <h1 id="eventTitleDisplay"></h1>
            <p id="eventDescriptionDisplay"></p>
        </div>
    </div>

    <div id="votingTableContainer"></div>
    <div id="submitContainer" style="text-align: center; margin-top: 20px; display: none;">
        <button class="submit-btn" onclick="submitVotes()">Submit</button>
    </div>

    <div id="nameCaptureModal" class="name-capture">
        <div class="name-capture-content">
            <h2>Welcome!</h2>
            <p>Please select your name to continue</p>
            <select id="voterName" class="name-select">
                <option value="">Choose your name...</option>
                <option value="Annie">Annie</option>
                <option value="Barrie">Barrie</option>
                <option value="Dorothy">Dorothy</option>
                <option value="Lisa">Lisa</option>
                <option value="Mindy">Mindy</option>
                <option value="Patti">Patti</option>
                <option value="Sue">Sue</option>
                <option value="Tiffanie">Tiffanie</option>
                <option value="Vena">Vena</option>
            </select>
            <button class="submit-btn" onclick="startVoting()">Continue</button>
        </div>
    </div>

    <script type="module">
        import { firebaseConfig } from './firebase-config.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { 
            getDatabase,
            ref, 
            set,
            get,
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let currentVotes = [];
        let voterName = '';

        function formatDateRange(dateRange) {
            const startDate = new Date(dateRange.start + 'T00:00:00');
            const endDate = new Date(dateRange.end + 'T00:00:00');
            
            // Check if it's a specific date (start equals end)
            if (dateRange.start === dateRange.end) {
                const dayOfWeek = startDate.toLocaleDateString('en-US', {
                    weekday: 'short',
                    timeZone: 'UTC'
                });
                const date = startDate.toLocaleDateString('en-US', {
                    month: '2-digit',
                    day: '2-digit',
                    year: '2-digit',
                    timeZone: 'UTC'
                });
                return `${dayOfWeek}<br>${date}`;
            }
            
            // If it's a date range, use the original format
            return `${startDate.toLocaleDateString('en-US', {
                month: '2-digit',
                day: '2-digit',
                year: '2-digit',
                timeZone: 'UTC'
            })} to ${endDate.toLocaleDateString('en-US', {
                month: '2-digit',
                day: '2-digit',
                year: '2-digit',
                timeZone: 'UTC'
            })}`;
        }

        function renderVotingTable(event) {
            const container = document.getElementById('votingTableContainer');
            const table = document.createElement('table');
            table.className = 'voting-table';
            
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = `<th>Name</th>`;
            event.dates.forEach(dateRange => {
                headerRow.innerHTML += `
                    <th>
                        <div class="date-header">
                            ${formatDateRange(dateRange)}
                        </div>
                    </th>`;
            });
            table.appendChild(headerRow);

            // Voting row - now inserted first
            const votingRow = document.createElement('tr');
            votingRow.innerHTML = `<td><strong>${voterName}</strong></td>`;
            
            // Initialize votes - start with pending state if new voter
            const existingVotes = event.participants?.[voterName]?.votes;
            currentVotes = existingVotes || new Array(event.dates.length).fill(-1); // Use -1 for pending state

            event.dates.forEach((_, index) => {
                let cellClass = 'vote-pending';
                let cellContent = '?';

                if (currentVotes[index] === 2) {
                    cellClass = 'vote-yes';
                    cellContent = '✓';
                } else if (currentVotes[index] === 0) {
                    cellClass = 'vote-no';
                    cellContent = '✗';
                }
                
                votingRow.innerHTML += `
                    <td onclick="window.toggleVote(${index})" class="${cellClass}">${cellContent}</td>`;
            });
            table.appendChild(votingRow);

            // Other participants - after the voting row
            Object.entries(event.participants || {}).forEach(([name, data]) => {
                if (name !== voterName) { // Only show other participants
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${name}</td>`;
                    data.votes.forEach(vote => {
                        const symbol = vote === 2 ? '✓' : '✗';
                        const voteClass = vote === 2 ? 'vote-yes' : 'vote-no';
                        row.innerHTML += `<td class="${voteClass}">${symbol}</td>`;
                    });
                    table.appendChild(row);
                }
            });

            container.innerHTML = '';
            container.appendChild(table);
        }

        window.toggleVote = function(index) {
            const currentValue = currentVotes[index];
            let newValue;
            let newClass;
            let newContent;
            
            if (currentValue === -1) { // From pending to yes
                newValue = 2;
                newClass = 'vote-yes';
                newContent = '✓';
            } else if (currentValue === 2) { // From yes to no
                newValue = 0;
                newClass = 'vote-no';
                newContent = '✗';
            } else { // From no back to pending
                newValue = -1;
                newClass = 'vote-pending';
                newContent = '?';
            }
            
            currentVotes[index] = newValue;
            // Get the voter's row - it's always the first row after the header
            const votingRow = document.querySelector('.voting-table tr:nth-child(2)');
            const cell = votingRow.children[index + 1];
            
            cell.className = newClass;
            cell.textContent = newContent;
        };

        window.startVoting = async function() {
            const nameInput = document.getElementById('voterName');
            if (!nameInput.value) {
                alert('Please enter your name');
                return;
            }
            
            voterName = nameInput.value;
            currentVotes = []; // Reset votes when starting
            document.getElementById('nameCaptureModal').style.display = 'none';
            document.getElementById('votingTableContainer').style.display = 'block';
            document.getElementById('submitContainer').style.display = 'block';
            await loadEventData();
        };

        async function loadEventData() {
            try {
                const eventId = new URLSearchParams(window.location.search).get('event');
                if (!eventId) {
                    throw new Error('No event ID provided');
                }

                const eventRef = ref(database, `events/${eventId}`);
                const eventSnap = await get(eventRef);
                
                if (eventSnap.exists()) {
                    const event = eventSnap.val();
                    document.getElementById('eventTitleDisplay').textContent = event.title;
                    document.getElementById('eventDescriptionDisplay').textContent = event.description;
                    
                    // Check for existing votes
                    if (event.participants && event.participants[voterName]) {
                        currentVotes = event.participants[voterName].votes;
                    }
                    
                    renderVotingTable(event);
                } else {
                    throw new Error('Event not found');
                }
            } catch (error) {
                alert('Error loading event: ' + error.message);
                console.error('Error loading event:', error);
            }
        }

        // Update the submit function to convert -1 to 0 before saving
        window.submitVotes = async function() {
            const eventId = new URLSearchParams(window.location.search).get('event');
            try {
                // Convert any remaining pending votes (-1) to no (0) before saving
                const finalVotes = currentVotes.map(v => v === -1 ? 0 : v);
                const eventRef = ref(database, `events/${eventId}/participants/${voterName}`);
                await set(eventRef, { name: voterName, votes: finalVotes });
                window.location.href = 'confirmation.html';
            } catch (error) {
                console.error('Error submitting votes:', error);
                alert('Error submitting votes');
            }
        };

        // Initialize name capture on page load
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const preselectedName = urlParams.get('name');
            if (preselectedName) {
                document.getElementById('voterName').value = preselectedName;
                window.startVoting();
            }
        });
    </script>
    <div class="instructions">
        <h1>How to Submit</h1>
        <ol>
            <li>Click the (?) under each date range to update</li>
            <li>(✓) means dates works for you</li>
            <li>(✗) means dates do not work for you</li>
            <li>(?) means you have selected yet</li>
            <li>Clicking again changes your selection</li>
            <li>Click "Submit" when finished</li>
        </ol>
    </div>
    <div>
        <p>&copy; 2024 Created by David Lewis</p>
    </div>

</body>
</html>